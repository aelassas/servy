# ==========================================================================================
# Servy Publish Workflow (.NET Framework 4.8)
# ------------------------------------------------------------------------------------------
# Builds all Servy components using .NET Framework 4.8, signs all executables using SignPath,
# builds the installer, creates the portable 7z archive, and uploads all signed artifacts.
#
# This build targets legacy systems. .NET Framework 4.8 ensures compatibility with older
# Windows versions that cannot run modern .NET (e.g., Windows 7, 8, 8.1).
# ==========================================================================================

name: publish

on:
  workflow_dispatch:

jobs:
  build-and-sign:
    runs-on: windows-latest

    env:
      ROOT_DIR: ${{ github.workspace }}
      BUILD_CONFIG: Release
      PLATFORM: x64
      FRAMEWORK: net48
      ISCC: 'C:\Program Files (x86)\Inno Setup 6\ISCC.exe'
      SEVEN_ZIP: 'C:\Program Files\7-Zip\7z.exe'

    steps:
      # -----------------------------------------------------
      # Checkout repository
      # -----------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Required for provenance

      # -----------------------------------------------------
      # Extract Version from setup/publish.ps1
      # -----------------------------------------------------
      - name: Get version from publish.ps1
        id: get_version
        shell: pwsh
        run: |
          $publishFile = "setup/publish.ps1"
          if (-not (Test-Path $publishFile)) { throw "cannot find publish.ps1" }
          $line = Get-Content $publishFile | Where-Object { $_ -match '^\s*\$Version\s*=\s*"(.*)"' }
          if (-not $line) { throw "Version line not found in $publishFile" }
          $v = ([regex]::Match($line, '"(.*)"')).Groups[1].Value
          if (-not $v) { throw "Failed to extract version" }
          Write-Host "Version found: $v"
          # proper output export
          "version=$v" >> $env:GITHUB_OUTPUT

      - name: Set VERSION env
        shell: pwsh
        run: |
          Add-Content -Path $env:GITHUB_ENV -Value "VERSION=${{ steps.get_version.outputs.version }}"

      - name: Verify VERSION is set
        shell: pwsh
        run: |
          if (-not $env:VERSION) { throw "VERSION env variable must be provided" }
          Write-Host "VERSION is set to $env:VERSION"

      # -----------------------------------------------------
      # Install Build dependencies
      # -----------------------------------------------------
      - uses: microsoft/setup-msbuild@v2
      - uses: nuget/setup-nuget@v2

      - name: Install Inno Setup
        shell: pwsh
        run: |
          $url = "https://files.jrsoftware.org/is/6/innosetup-6.6.1.exe"
          Invoke-WebRequest -Uri $url -OutFile "innosetup.exe" -ErrorAction Stop
          Start-Process ".\innosetup.exe" -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES" -Wait
          if (-not (Test-Path $env:ISCC)) { throw "ISCC.exe not found at $env:ISCC" }

      - name: Install 7zip
        shell: pwsh
        run: |
          $url = "https://www.7-zip.org/a/7z2501-x64.exe"
          Invoke-WebRequest -Uri $url -OutFile "7z.exe" -ErrorAction Stop
          Start-Process ".\7z.exe" -ArgumentList "/S" -Wait
          if (-not (Test-Path $env:SEVEN_ZIP)) { throw "7z.exe not found at $env:SEVEN_ZIP" }

      # -----------------------------------------------------
      # Build solution
      # -----------------------------------------------------
      - name: Build Servy.sln
        shell: pwsh
        run: |
          Write-Host "Restoring NuGet packages..."
          nuget restore "Servy.sln"

          Write-Host "Building Servy.sln..."
          msbuild Servy.sln `
            /t:Clean,Rebuild `
            /p:Configuration=$env:BUILD_CONFIG `
            /p:Platform=$env:PLATFORM `
            /p:AllowUnsafeBlocks=true

      # -----------------------------------------------------
      # Run unit tests
      # -----------------------------------------------------
      - name: Run unit tests
        shell: pwsh
        run: |
          # Common paths for vstest.console.exe
          $possiblePaths = @(
                "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\IDE\Extensions\TestPlatform\vstest.console.exe",
                "C:\Program Files\Microsoft Visual Studio\2022\Professional\Common7\IDE\Extensions\TestPlatform\vstest.console.exe",
                "C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\IDE\Extensions\TestPlatform\vstest.console.exe",
                "C:\Program Files\Microsoft Visual Studio\2022\BuildTools\Common7\IDE\Extensions\TestPlatform\vstest.console.exe"
            )

          $vsTest = $possiblePaths | Where-Object { Test-Path $_ } | Select-Object -First 1

          if (-not $vsTest) {
              throw "Could not locate vstest.console.exe on the runner."
          }

          Write-Host "Using vstest.console.exe at: $vsTest"

          Write-Host "Building Servy.sln in Debug..."
          msbuild Servy.sln `
            /t:Clean,Rebuild `
            /p:Configuration=Debug `
            /p:Platform=$env:PLATFORM `
            /p:AllowUnsafeBlocks=true

          # Find all test assemblies
          $testDlls = Get-ChildItem -Path "tests/*/bin/*/Debug/*.UnitTests.dll" -File

          if (-not $testDlls) {
              throw "No test assemblies with *.UnitTests.dll found!"
          }

          Write-Host "Found test assemblies:"
          $testDlls | ForEach-Object { Write-Host " - $($_.FullName)" }

          foreach ($dll in $testDlls) {
              Write-Host "`nRunning tests in $($dll.FullName)..."
              & $vsTest $dll.FullName /Framework:".NETFramework,Version=v4.8" /logger:trx

              if ($LASTEXITCODE -ne 0) {
                  throw "Unit tests failed in $($dll.FullName)"
              }
          }
  
      # -----------------------------------------------------
      # Build UNSIGNED Servy.Restarter.exe
      # -----------------------------------------------------
      - name: Build Servy.Restarter.exe
        shell: pwsh
        run: |
          $BuildConfiguration = $env:BUILD_CONFIG
          $Platform           = $env:PLATFORM
          $ProjectPath        = "src/Servy.Restarter/Servy.Restarter.csproj"

          msbuild $ProjectPath `
            /t:Clean,Rebuild `
            /p:Configuration=$BuildConfiguration `
            /p:Platform=$Platform `
            /p:AllowUnsafeBlocks=true

      # -----------------------------------------------------
      # SIGN Servy.Restarter.exe
      # -----------------------------------------------------
      - name: Upload Servy.Restarter.exe (unsigned)
        id: unsigned-restarter
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-restarter
          path: src/Servy.Restarter/bin/${{ env.PLATFORM }}/${{ env.BUILD_CONFIG }}/Servy.Restarter.exe
          if-no-files-found: error
          retention-days: 1

      - name: Submit Servy.Restarter.exe for signing
        uses: signpath/github-action-submit-signing-request@v2
        with:
          organization-id: ${{ secrets.SIGNPATH_ORG_ID }}
          project-slug: ${{ vars.SIGNPATH_PROJECT_SLUG }}
          signing-policy-slug: ${{ vars.SIGNPATH_POLICY_SLUG }}
          api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
          github-artifact-id: '${{ steps.unsigned-restarter.outputs.artifact-id }}'
          artifact-configuration-slug: 'servy-restarter'
          wait-for-completion: true
          output-artifact-directory: 'signed/Servy.Restarter'

      - name: Inject signed Servy.Restarter.exe
        shell: pwsh
        run: |
          $file = "signed/Servy.Restarter/Servy.Restarter.exe"
          if (-not (Test-Path $file)) { throw "Signed Servy.Restarter.exe not found!" }
          Copy-Item $file src/Servy.Service/Resources/Servy.Restarter.exe -Force

      # -----------------------------------------------------
      # Build UNSIGNED Servy.Service.exe
      # -----------------------------------------------------
      - name: Build Servy.Service.exe
        shell: pwsh
        run: |
          $BuildConfiguration = $env:BUILD_CONFIG
          $Platform           = $env:PLATFORM
          $ProjectPath        = "src/Servy.Service/Servy.Service.csproj"

          msbuild $ProjectPath `
            /t:Clean,Rebuild `
            /p:Configuration=$BuildConfiguration `
            /p:Platform=$Platform `
            /p:AllowUnsafeBlocks=true

      # -----------------------------------------------------
      # SIGN Servy.Service.exe
      # -----------------------------------------------------
      - name: Upload Servy.Service.exe (unsigned)
        id: unsigned-service
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-service
          path: src/Servy.Service/bin/${{ env.PLATFORM }}/${{ env.BUILD_CONFIG }}/Servy.Service.exe
          if-no-files-found: error
          retention-days: 1

      - name: Submit Servy.Service.exe for signing
        uses: signpath/github-action-submit-signing-request@v2
        with:
          organization-id: ${{ secrets.SIGNPATH_ORG_ID }}
          project-slug: ${{ vars.SIGNPATH_PROJECT_SLUG }}
          signing-policy-slug: ${{ vars.SIGNPATH_POLICY_SLUG }}
          api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
          github-artifact-id: '${{ steps.unsigned-service.outputs.artifact-id }}'
          artifact-configuration-slug: 'servy-service'
          wait-for-completion: true
          output-artifact-directory: 'signed/Servy.Service'

      - name: Inject signed Servy.Service.exe
        shell: pwsh
        run: |
          $signed = "signed/Servy.Service/Servy.Service.exe"
          if (-not (Test-Path $signed)) { throw "Signed Servy.Service.exe not found!" }

          $targets = @(
              @{ Path = "src/Servy/Resources";           Name = "Servy.Service.Net48.exe" },
              @{ Path = "src/Servy.Manager/Resources";   Name = "Servy.Service.Net48.exe" },
              @{ Path = "src/Servy.CLI/Resources";       Name = "Servy.Service.Net48.CLI.exe" }
          )

          # Inject the signed EXE into each resource folder
          foreach ($t in $targets) {
              Copy-Item $signed "$($t.Path)/$($t.Name)" -Force
              Copy-Item "src/Servy.Service/bin/$env:PLATFORM/$env:BUILD_CONFIG/*.dll" $t.Path -Force
          }

      # -----------------------------------------------------
      # Build UNSIGNED Servy.exe
      # -----------------------------------------------------
      - name: Build Servy.exe
        shell: pwsh
        run: |
          $BuildConfiguration = $env:BUILD_CONFIG
          $Platform           = $env:PLATFORM
          $ProjectPath        = "src/Servy/Servy.csproj"

          msbuild $ProjectPath `
            /t:Clean,Rebuild `
            /p:Configuration=$BuildConfiguration `
            /p:Platform=$Platform `
            /p:AllowUnsafeBlocks=true

      # -----------------------------------------------------
      # SIGN Servy.exe
      # -----------------------------------------------------
      - name: Upload Servy.exe (unsigned)
        id: unsigned-servy
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-servy
          path: src/Servy/bin/${{ env.PLATFORM }}/${{ env.BUILD_CONFIG }}/Servy.exe
          if-no-files-found: error
          retention-days: 1

      - name: Submit Servy.exe for signing
        uses: signpath/github-action-submit-signing-request@v2
        with:
          organization-id: ${{ secrets.SIGNPATH_ORG_ID }}
          project-slug: ${{ vars.SIGNPATH_PROJECT_SLUG }}
          signing-policy-slug: ${{ vars.SIGNPATH_POLICY_SLUG }}
          api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
          github-artifact-id: '${{ steps.unsigned-servy.outputs.artifact-id }}'
          artifact-configuration-slug: 'servy'
          wait-for-completion: true
          output-artifact-directory: 'signed/Servy'

      - name: Inject signed Servy.exe
        shell: pwsh
        run: |
          $file = "signed/Servy/Servy.exe"
          if (-not (Test-Path $file)) { throw "Signed Servy.exe not found!" }
          Copy-Item $file src/Servy/bin/$env:PLATFORM/$env:BUILD_CONFIG/Servy.exe -Force

      # -----------------------------------------------------
      # Build UNSIGNED Servy.Manager.exe
      # -----------------------------------------------------
      - name: Build Servy.Manager.exe
        shell: pwsh
        run: |
          $BuildConfiguration = $env:BUILD_CONFIG
          $Platform           = $env:PLATFORM
          $ProjectPath        = "src/Servy.Manager/Servy.Manager.csproj"

          msbuild $ProjectPath `
            /t:Clean,Rebuild `
            /p:Configuration=$BuildConfiguration `
            /p:Platform=$Platform `
            /p:AllowUnsafeBlocks=true

      # -----------------------------------------------------
      # SIGN Servy.Manager.exe
      # -----------------------------------------------------
      - name: Upload Servy.Manager.exe (unsigned)
        id: unsigned-manager
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-manager
          path: src/Servy.Manager/bin/${{ env.PLATFORM }}/${{ env.BUILD_CONFIG }}/Servy.Manager.exe
          if-no-files-found: error
          retention-days: 1

      - name: Submit Servy.Manager.exe for signing
        uses: signpath/github-action-submit-signing-request@v2
        with:
          organization-id: ${{ secrets.SIGNPATH_ORG_ID }}
          project-slug: ${{ vars.SIGNPATH_PROJECT_SLUG }}
          signing-policy-slug: ${{ vars.SIGNPATH_POLICY_SLUG }}
          api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
          github-artifact-id: '${{ steps.unsigned-manager.outputs.artifact-id }}'
          artifact-configuration-slug: 'servy-manager'
          wait-for-completion: true
          output-artifact-directory: 'signed/Servy.Manager'

      - name: Inject signed Servy.Manager.exe
        shell: pwsh
        run: |
          $file = "signed/Servy.Manager/Servy.Manager.exe"
          if (-not (Test-Path $file)) { throw "Signed Servy.Manager.exe not found!" }
          Copy-Item $file src/Servy.Manager/bin/$env:PLATFORM/$env:BUILD_CONFIG/Servy.Manager.exe -Force

      # -----------------------------------------------------
      # Build UNSIGNED Servy.CLI.exe
      # -----------------------------------------------------
      - name: Build Servy.CLI.exe
        shell: pwsh
        run: |
          $BuildConfiguration = $env:BUILD_CONFIG
          $Platform           = $env:PLATFORM
          $ProjectPath        = "src/Servy.CLI/Servy.CLI.csproj"

          msbuild $ProjectPath `
            /t:Clean,Rebuild `
            /p:Configuration=$BuildConfiguration `
            /p:Platform=$Platform `
            /p:AllowUnsafeBlocks=true

      # -----------------------------------------------------
      # SIGN Servy.CLI.exe
      # -----------------------------------------------------
      - name: Upload Servy.CLI.exe (unsigned)
        id: unsigned-cli
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-cli
          path: src/Servy.CLI/bin/${{ env.PLATFORM }}/${{ env.BUILD_CONFIG }}/Servy.CLI.exe
          if-no-files-found: error
          retention-days: 1

      - name: Submit Servy.CLI.exe for signing
        uses: signpath/github-action-submit-signing-request@v2
        with:
          organization-id: ${{ secrets.SIGNPATH_ORG_ID }}
          project-slug: ${{ vars.SIGNPATH_PROJECT_SLUG }}
          signing-policy-slug: ${{ vars.SIGNPATH_POLICY_SLUG }}
          api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
          github-artifact-id: '${{ steps.unsigned-cli.outputs.artifact-id }}'
          artifact-configuration-slug: 'servy-cli'
          wait-for-completion: true
          output-artifact-directory: 'signed/Servy.CLI'

      - name: Inject signed Servy.CLI.exe
        shell: pwsh
        run: |
          $file = "signed/Servy.CLI/Servy.CLI.exe"
          if (-not (Test-Path $file)) { throw "Signed Servy.CLI.exe not found!" }
          Copy-Item $file src/Servy.CLI/bin/$env:PLATFORM/$env:BUILD_CONFIG/Servy.CLI.exe -Force

      # -----------------------------------------------------
      # Build UNSIGNED installer
      # -----------------------------------------------------
      - name: Build unsigned installer
        shell: pwsh
        run: |
          & $env:ISCC "setup\servy.iss" `
            /DMyAppVersion=$env:VERSION `
            /DMyAppPlatform=$env:FRAMEWORK

      # -----------------------------------------------------
      # SIGN installer
      # -----------------------------------------------------
      - name: Rename unsigned installer
        shell: pwsh
        run: |
          $source = "setup/servy-$env:VERSION-$env:FRAMEWORK-x64-installer.exe"
          $target = "servy-x64-installer.exe"
          if (-not (Test-Path $source)) { throw "Unsigned installer not found: $source" }
          Rename-Item -Path $source -NewName $target -Force

      - name: Upload installer (unsigned)
        id: unsigned-installer
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-installer
          path: setup/servy-x64-installer.exe
          if-no-files-found: error
          retention-days: 1

      - name: Submit installer for signing
        uses: signpath/github-action-submit-signing-request@v2
        with:
          organization-id: ${{ secrets.SIGNPATH_ORG_ID }}
          project-slug: ${{ vars.SIGNPATH_PROJECT_SLUG }}
          signing-policy-slug: ${{ vars.SIGNPATH_POLICY_SLUG }}
          api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
          github-artifact-id: '${{ steps.unsigned-installer.outputs.artifact-id }}'
          artifact-configuration-slug: 'servy-installer'
          wait-for-completion: true
          output-artifact-directory: 'signed/installer'

      - name: Rename signed installer
        shell: pwsh
        run: |
          $source = "signed/installer/servy-x64-installer.exe"
          $target = "servy-$env:VERSION-$env:FRAMEWORK-x64-installer.exe"
          if (-not (Test-Path $source)) { throw "Signed installer not found: $source" }
          Rename-Item -Path $source -NewName $target -Force

      - name: Upload signed installer
        uses: actions/upload-artifact@v4
        with:
          name: signed-installer
          path: signed/installer/servy-${{ env.VERSION }}-${{ env.FRAMEWORK }}-x64-installer.exe
          if-no-files-found: error
          retention-days: 1

      # -----------------------------------------------------
      # Build portable 7z package
      # -----------------------------------------------------
      - name: Build portable 7z package
        shell: pwsh
        run: |
          $name = "servy-$env:VERSION-$env:FRAMEWORK-$env:PLATFORM-portable"
          $pkg = "$name"
          New-Item -ItemType Directory -Force -Path $pkg | Out-Null

          $servy = "src/Servy/bin/${{ env.PLATFORM }}/${{ env.BUILD_CONFIG }}"
          $cli = "src/Servy.CLI/bin/${{ env.PLATFORM }}/${{ env.BUILD_CONFIG }}"
          $manager = "src/Servy.Manager/bin/${{ env.PLATFORM }}/${{ env.BUILD_CONFIG }}"

          # Desktop app and Manager app
          Copy-Item "$servy\*" $pkg -Recurse -Force
          Copy-Item "$manager\*" $pkg -Recurse -Force

          # CLI
          Copy-Item "$cli\*" "$pkg" -Recurse -Force
          
          # Rename Servy.CLI.exe to servy-cli.exe
          $sourceExe  = Join-Path $pkg "Servy.CLI.exe"
          $targetName = "servy-cli.exe"

          if (Test-Path $sourceExe) {
              Rename-Item -Path $sourceExe -NewName $targetName -Force
          } else {
              Write-Error "Servy.CLI.exe not found in $pkg"
          }

          # PowerShell module
          Copy-Item "src/Servy.CLI/Servy.psm1" $pkg -Force
          Copy-Item "src/Servy.CLI/servy-module-examples.ps1" $pkg -Force
          
          # Remove *.pdb, *.config, *.xml files
          $exts = @("*.pdb", "*.config", "*.xml")

          foreach ($ext in $exts) {
              Get-ChildItem -Path $pkg -Recurse -Filter $ext -File | Remove-Item -Force
          }

          # Task Scheduler setup
          Copy-Item "setup\taskschd" $pkg -Recurse -Force

          $zip = "$name.7z"

          # use advanced compression config
          & $env:SEVEN_ZIP a `
            -t7z `
            -m0=lzma2 `
            -mx=9 `
            -mfb=273 `
            -md=32m `
            -ms=on `
            "$zip" `
            "$pkg"

          Remove-Item $pkg -Recurse -Force

      - name: Upload portable package
        uses: actions/upload-artifact@v4
        with:
          name: portable-7z
          path: servy-${{ env.VERSION }}-${{ env.FRAMEWORK }}-x64-portable.7z
          if-no-files-found: error
          retention-days: 1

      # -----------------------------------------------------
      # Scan with VirusTotal
      # -----------------------------------------------------
      - name: Scan signed installer and portable package with VirusTotal
        uses: cssnr/virustotal-action@v1
        with:
          vt_api_key: ${{ secrets.VIRUSTOTAL_API_KEY }}
          sha256: true
          file_globs: |
            signed/installer/servy-${{ env.VERSION }}-${{ env.FRAMEWORK }}-x64-installer.exe
            servy-${{ env.VERSION }}-${{ env.FRAMEWORK }}-x64-portable.7z
