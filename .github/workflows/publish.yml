name: publish

on:
  workflow_dispatch:

jobs:
  build-and-sign:
    runs-on: windows-latest

    env:
      ROOT_DIR: ${{ github.workspace }}

    steps:
      # -----------------------------------------------------
      # CHECKOUT
      # -----------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Required for provenance

      # -----------------------------------------------------
      # EXTRACT VERSION FROM setup/publish.ps1
      # -----------------------------------------------------
      - name: Get version from publish.ps1
        shell: pwsh
        id: get_version
        run: |
          $publishFile = "setup/publish.ps1"
          if (-not (Test-Path $publishFile)) {
              throw "Cannot find $publishFile"
          }
          $versionLine = Get-Content $publishFile | Where-Object { $_ -match '^\s*\$Version\s*=\s*"(.*)"' }
          if (-not $versionLine) {
              throw "Cannot find version assignment in $publishFile"
          }
          $matches = [regex]::Match($versionLine, '^\s*\$Version\s*=\s*"(.*)"')
          $version = $matches.Groups[1].Value
          Write-Host "Version found: $version"

          # proper output export
          "version=$version" >> $env:GITHUB_OUTPUT

      # -----------------------------------------------------
      # CREATE setup/.signpath FILE
      # -----------------------------------------------------
      - name: Create temporary .signpath for GitHub Actions
        shell: pwsh
        env:
          SIGNPATH_API_TOKEN: ${{ secrets.SIGNPATH_API_TOKEN }}
        run: |
          $SignPathFile = "setup/.signpath"
          $content = @(
              "SIGN=true",
              "API_TOKEN=$env:SIGNPATH_API_TOKEN",
              "ORGANIZATION_ID=e2c60587-5f20-4593-ab8b-c7eab6b7bfb6",
              "PROJECT_SLUG=servy",
              "SIGNING_POLICY_SLUG=test-signing"
          ) -join [Environment]::NewLine
          [System.IO.File]::WriteAllText($SignPathFile, $content, [System.Text.Encoding]::UTF8)
          Write-Host "Created temporary $SignPathFile"

      # -----------------------------------------------------
      # INSTALL BUILD DEPENDENCIES
      # -----------------------------------------------------

# TODO finish the rest of the publish workflow