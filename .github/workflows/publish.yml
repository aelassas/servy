# ==========================================================================================
# Servy Publish Workflow (.NET)
# ------------------------------------------------------------------------------------------
# Builds all Servy components using the modern .NET SDK, signs all executables using SignPath,
# builds the installer, creates the portable 7z archive, and uploads all signed artifacts.
#
# This build targets Windows 10, Windows 11, and Windows Server (x64) editions. It provides 
# better performance, runtime features, trimming, and overall modern platform support.
# ==========================================================================================

name: publish

on:
  workflow_dispatch:

jobs:
  build-and-sign:
    runs-on: windows-latest

    env:
      ROOT_DIR: ${{ github.workspace }}
      CONFIGURATION: Release
      RUNTIME: win-x64
      TFM: net10.0-windows
      ISCC: 'C:\Program Files (x86)\Inno Setup 6\ISCC.exe'
      SEVEN_ZIP: 'C:\Program Files\7-Zip\7z.exe'

    steps:
      # -----------------------------------------------------
      # Checkout repository
      # -----------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Required for provenance

      # -----------------------------------------------------
      # Extract Version from setup/publish.ps1
      # -----------------------------------------------------
      - name: Get version from publish.ps1
        shell: pwsh
        id: get_version
        run: |
          $publishFile = "setup/publish.ps1"
          if (-not (Test-Path $publishFile)) { throw "Cannot find $publishFile" }
          $line = Get-Content $publishFile | Where-Object { $_ -match '^\s*\[string\]\$Version\s*=\s*"(.*)"' }
          if (-not $line) { throw "Version line not found in $publishFile" }
          $v = ([regex]::Match($line, '"(.*)"')).Groups[1].Value
          if (-not $v) { throw "Failed to extract version" }
          Write-Host "Version found: $v"
          # proper output export
          Add-Content -Path $env:GITHUB_OUTPUT -Value "version=$v"

      - name: Set VERSION env
        shell: pwsh
        run: |
          Add-Content -Path $env:GITHUB_ENV -Value "VERSION=${{ steps.get_version.outputs.version }}"

      - name: Verify VERSION is set
        shell: pwsh
        run: |
          if (-not $env:VERSION) { throw "VERSION env variable is not set." }
          Write-Host "VERSION is set to $env:VERSION"

      # -----------------------------------------------------
      # Install Build dependencies
      # -----------------------------------------------------
      - name: Install the latest .NET SDK
        shell: powershell
        run: |
          $url = "https://dot.net/v1/dotnet-install.ps1"
          Invoke-WebRequest -Uri $url -OutFile "dotnet-install.ps1" -ErrorAction Stop
          ./dotnet-install.ps1 -Version "latest" -InstallDir "$env:RUNNER_TEMP\dotnet"
          Add-Content -Path $env:GITHUB_PATH -Value "$env:RUNNER_TEMP\dotnet"

      - name: Check .NET version
        run: dotnet --version

      - name: Install CycloneDX .NET Tool
        shell: pwsh
        run: |
          dotnet tool install --global CycloneDX
          Add-Content -Path $env:GITHUB_PATH -Value "$env:USERPROFILE\.dotnet\tools"

      - name: Install CycloneDX CLI
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://github.com/CycloneDX/cyclonedx-cli/releases/download/v0.29.2/cyclonedx-win-x64.exe" -OutFile "$env:USERPROFILE\cyclonedx.exe"
          Add-Content -Path $env:GITHUB_PATH -Value $env:USERPROFILE

      - name: Install Inno Setup
        shell: pwsh
        run: |
          $url = "https://files.jrsoftware.org/is/6/innosetup-6.6.1.exe"
          Invoke-WebRequest -Uri $url -OutFile "innosetup.exe" -ErrorAction Stop
          Start-Process ".\innosetup.exe" -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES" -Wait
          if (-not (Test-Path $env:ISCC)) { throw "ISCC.exe not found at $env:ISCC" }

      - name: Install 7zip
        shell: pwsh
        run: |
          $url = "https://www.7-zip.org/a/7z2501-x64.exe"
          Invoke-WebRequest -Uri $url -OutFile "7z.exe" -ErrorAction Stop
          Start-Process ".\7z.exe" -ArgumentList "/S" -Wait
          if (-not (Test-Path $env:SEVEN_ZIP)) { throw "7z.exe not found at $env:SEVEN_ZIP" }

      # -----------------------------------------------------
      # Build projects individually
      # -----------------------------------------------------
      - name: Build Servy projects
        shell: pwsh
        run: |
          $projects = @(
            "src\Servy.Restarter\Servy.Restarter.csproj",
            "src\Servy.Service\Servy.Service.csproj",
            "src\Servy\Servy.csproj",
            "src\Servy.CLI\Servy.CLI.csproj",
            "src\Servy.Manager\Servy.Manager.csproj"
          )

          foreach ($proj in $projects) {
            Write-Host "Restoring $proj..."
            dotnet restore $proj --runtime win-x64
          }

          foreach ($proj in $projects) {
            Write-Host "Building $proj ($env:CONFIGURATION)..."
            dotnet build $proj --configuration $env:CONFIGURATION --no-restore
          }

      # -----------------------------------------------------
      # Run unit tests
      # -----------------------------------------------------
      - name: Run unit tests
        shell: pwsh
        run: dotnet test Servy.sln --configuration Debug

      # -----------------------------------------------------
      # Build and Publish SBOM
      # -----------------------------------------------------
      - name: Generate SBOM
        shell: pwsh
        run: |
          $version = "$env:VERSION.0"
          dotnet-CycloneDX "src\Servy\Servy.csproj" --recursive --set-version "$version" --output . --filename "sbom-Servy.xml"
          dotnet-CycloneDX "src\Servy.CLI\Servy.CLI.csproj" --recursive --set-version "$version" --output . --filename "sbom-Servy.CLI.xml"
          dotnet-CycloneDX "src\Servy.Manager\Servy.Manager.csproj" --recursive --set-version "$version" --output . --filename "sbom-Servy.Manager.xml"
          dotnet-CycloneDX "src\Servy.Restarter\Servy.Restarter.csproj" --recursive --set-version "$version" --output . --filename "sbom-Servy.Restarter.xml"
          dotnet-CycloneDX "src\Servy.Service\Servy.Service.csproj" --recursive --set-version "$version" --output . --filename "sbom-Servy.Service.xml"
          
          # Merge into servy-$env:VERSION-sbom.xml
          cyclonedx merge --input-files `
            sbom-Servy.xml `
            sbom-Servy.CLI.xml `
            sbom-Servy.Manager.xml `
            sbom-Servy.Restarter.xml `
            sbom-Servy.Service.xml `
            --output-file "servy-$env:VERSION-sbom.xml"

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ env.VERSION }}-sbom
          path: servy-${{ env.VERSION }}-sbom.xml
          if-no-files-found: error
          retention-days: 1

      # -----------------------------------------------------
      # Build UNSIGNED Servy.Restarter.exe
      # -----------------------------------------------------
      - name: Build Servy.Restarter.exe
        shell: pwsh
        run: |
          $configuration = $env:CONFIGURATION
          $runtime       = $env:RUNTIME
          $tfm           = $env:TFM
          $projectPath   = Resolve-Path "src\Servy.Restarter\Servy.Restarter.csproj"
          $publishDir    = "src\Servy.Restarter\bin\$configuration\$tfm\$runtime\publish"

          dotnet publish $projectPath `
              -c $configuration `
              -r $runtime `
              -f $tfm `
              -o $publishDir `
              --force `
              /p:DeleteExistingFiles=true

      # -----------------------------------------------------
      # SIGN Servy.Restarter.exe
      # -----------------------------------------------------
      - name: Upload Servy.Restarter.exe (unsigned)
        id: unsigned-restarter
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-restarter
          path: src/Servy.Restarter/bin/${{ env.CONFIGURATION }}/${{ env.TFM }}/${{ env.RUNTIME }}/publish/Servy.Restarter.exe
          if-no-files-found: error
          retention-days: 1

      - name: Submit Servy.Restarter.exe for signing
        uses: signpath/github-action-submit-signing-request@v2
        with:
          organization-id: ${{ secrets.SIGNPATH_ORG_ID }}
          project-slug: ${{ vars.SIGNPATH_PROJECT_SLUG }}
          signing-policy-slug: ${{ vars.SIGNPATH_POLICY_SLUG }}
          api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
          github-artifact-id: '${{ steps.unsigned-restarter.outputs.artifact-id }}'
          artifact-configuration-slug: 'servy-restarter'
          wait-for-completion: true
          output-artifact-directory: 'signed/Servy.Restarter'

      - name: Inject signed Servy.Restarter.exe
        shell: pwsh
        run: |
          $file = "signed/Servy.Restarter/Servy.Restarter.exe"
          if (-not (Test-Path $file)) { throw "Signed Servy.Restarter.exe not found!" }
          Copy-Item $file src/Servy.Service/Resources/Servy.Restarter.exe -Force

      # -----------------------------------------------------
      # Build UNSIGNED Servy.Service.exe
      # -----------------------------------------------------
      - name: Build Servy.Service.exe
        shell: pwsh
        run: |
          $configuration = $env:CONFIGURATION
          $runtime       = $env:RUNTIME
          $tfm           = $env:TFM
          $projectPath   = Resolve-Path "src\Servy.Service\Servy.Service.csproj"
          $publishDir    = "src\Servy.Service\bin\$configuration\$tfm\$runtime\publish"

          dotnet publish $projectPath `
              -c $configuration `
              -r $runtime `
              -f $tfm `
              -o $publishDir `
              --force `
              /p:DeleteExistingFiles=true

      # -----------------------------------------------------
      # SIGN Servy.Service.exe
      # -----------------------------------------------------
      - name: Upload Servy.Service.exe (unsigned)
        id: unsigned-service
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-service
          path: src/Servy.Service/bin/${{ env.CONFIGURATION }}/${{ env.TFM }}/${{ env.RUNTIME }}/publish/Servy.Service.exe
          if-no-files-found: error
          retention-days: 1

      - name: Submit Servy.Service.exe for signing
        uses: signpath/github-action-submit-signing-request@v2
        with:
          organization-id: ${{ secrets.SIGNPATH_ORG_ID }}
          project-slug: ${{ vars.SIGNPATH_PROJECT_SLUG }}
          signing-policy-slug: ${{ vars.SIGNPATH_POLICY_SLUG }}
          api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
          github-artifact-id: '${{ steps.unsigned-service.outputs.artifact-id }}'
          artifact-configuration-slug: 'servy-service'
          wait-for-completion: true
          output-artifact-directory: 'signed/Servy.Service'

      - name: Inject signed Servy.Service.exe
        shell: pwsh
        run: |
          $signed = "signed/Servy.Service/Servy.Service.exe"
          if (-not (Test-Path $signed)) { throw "Signed Servy.Service.exe not found!" }

          $targets = @(
              "src/Servy/Resources/Servy.Service.exe",
              "src/Servy.Manager/Resources/Servy.Service.exe",
              "src/Servy.CLI/Resources/Servy.Service.CLI.exe"
          )

          # Inject the signed EXE into each resource folder
          foreach ($dst in $targets) {
              Write-Host "Injecting SIGNED Servy.Service.exe into $dst"
              Copy-Item $signed $dst -Force
          }

      # -----------------------------------------------------
      # Build UNSIGNED Servy.exe
      # -----------------------------------------------------
      - name: Build Servy.exe
        shell: pwsh
        run: |
          $configuration = $env:CONFIGURATION
          $runtime       = $env:RUNTIME
          $tfm           = $env:TFM
          $projectPath   = Resolve-Path "src\Servy\Servy.csproj"
          $publishDir    = "src\Servy\bin\$configuration\$tfm\$runtime\publish"

          dotnet publish $projectPath `
              -c $configuration `
              -r $runtime `
              -f $tfm `
              -o $publishDir `
              --force `
              /p:DeleteExistingFiles=true

      # -----------------------------------------------------
      # SIGN Servy.exe
      # -----------------------------------------------------
      - name: Upload Servy.exe (unsigned)
        id: unsigned-servy
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-servy
          path: src/Servy/bin/${{ env.CONFIGURATION }}/${{ env.TFM }}/${{ env.RUNTIME }}/publish/Servy.exe
          if-no-files-found: error
          retention-days: 1

      - name: Submit Servy.exe for signing
        uses: signpath/github-action-submit-signing-request@v2
        with:
          organization-id: ${{ secrets.SIGNPATH_ORG_ID }}
          project-slug: ${{ vars.SIGNPATH_PROJECT_SLUG }}
          signing-policy-slug: ${{ vars.SIGNPATH_POLICY_SLUG }}
          api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
          github-artifact-id: '${{ steps.unsigned-servy.outputs.artifact-id }}'
          artifact-configuration-slug: 'servy'
          wait-for-completion: true
          output-artifact-directory: 'signed/Servy'

      - name: Inject signed Servy.exe
        shell: pwsh
        run: |
          $file = "signed/Servy/Servy.exe"
          if (-not (Test-Path $file)) { throw "Signed Servy.exe not found!" }
          Copy-Item $file src/Servy/bin/$env:CONFIGURATION/$env:TFM/$env:RUNTIME/publish/Servy.exe -Force

      # -----------------------------------------------------
      # Build UNSIGNED Servy.Manager.exe
      # -----------------------------------------------------
      - name: Build Servy.Manager.exe
        shell: pwsh
        run: |
          $configuration = $env:CONFIGURATION
          $runtime       = $env:RUNTIME
          $tfm           = $env:TFM
          $projectPath   = Resolve-Path "src\Servy.Manager\Servy.Manager.csproj"
          $publishDir    = "src\Servy.Manager\bin\$configuration\$tfm\$runtime\publish"

          dotnet publish $projectPath `
              -c $configuration `
              -r $runtime `
              -f $tfm `
              -o $publishDir `
              --force `
              /p:DeleteExistingFiles=true

      # -----------------------------------------------------
      # SIGN Servy.Manager.exe
      # -----------------------------------------------------
      - name: Upload Servy.Manager.exe (unsigned)
        id: unsigned-manager
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-manager
          path: src/Servy.Manager/bin/${{ env.CONFIGURATION }}/${{ env.TFM }}/${{ env.RUNTIME }}/publish/Servy.Manager.exe
          if-no-files-found: error
          retention-days: 1

      - name: Submit Servy.Manager.exe for signing
        uses: signpath/github-action-submit-signing-request@v2
        with:
          organization-id: ${{ secrets.SIGNPATH_ORG_ID }}
          project-slug: ${{ vars.SIGNPATH_PROJECT_SLUG }}
          signing-policy-slug: ${{ vars.SIGNPATH_POLICY_SLUG }}
          api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
          github-artifact-id: '${{ steps.unsigned-manager.outputs.artifact-id }}'
          artifact-configuration-slug: 'servy-manager'
          wait-for-completion: true
          output-artifact-directory: 'signed/Servy.Manager'

      - name: Inject signed Servy.Manager.exe
        shell: pwsh
        run: |
          $file = "signed/Servy.Manager/Servy.Manager.exe"
          if (-not (Test-Path $file)) { throw "Signed Servy.Manager.exe not found!" }
          Copy-Item $file src/Servy.Manager/bin/$env:CONFIGURATION/$env:TFM/$env:RUNTIME/publish/Servy.Manager.exe -Force

      # -----------------------------------------------------
      # Build UNSIGNED Servy.CLI.exe
      # -----------------------------------------------------
      - name: Build Servy.CLI.exe
        shell: pwsh
        run: |
          $configuration = $env:CONFIGURATION
          $runtime       = $env:RUNTIME
          $tfm           = $env:TFM
          $projectPath   = Resolve-Path "src\Servy.CLI\Servy.CLI.csproj"
          $publishDir    = "src\Servy.CLI\bin\$configuration\$tfm\$runtime\publish"

          dotnet publish $projectPath `
              -c $configuration `
              -r $runtime `
              -f $tfm `
              -o $publishDir `
              --force `
              /p:DeleteExistingFiles=true

      # -----------------------------------------------------
      # SIGN Servy.CLI.exe
      # -----------------------------------------------------
      - name: Upload Servy.CLI.exe (unsigned)
        id: unsigned-cli
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-cli
          path: src/Servy.CLI/bin/${{ env.CONFIGURATION }}/${{ env.TFM }}/${{ env.RUNTIME }}/publish/Servy.CLI.exe
          if-no-files-found: error
          retention-days: 1

      - name: Submit Servy.CLI.exe for signing
        uses: signpath/github-action-submit-signing-request@v2
        with:
          organization-id: ${{ secrets.SIGNPATH_ORG_ID }}
          project-slug: ${{ vars.SIGNPATH_PROJECT_SLUG }}
          signing-policy-slug: ${{ vars.SIGNPATH_POLICY_SLUG }}
          api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
          github-artifact-id: '${{ steps.unsigned-cli.outputs.artifact-id }}'
          artifact-configuration-slug: 'servy-cli'
          wait-for-completion: true
          output-artifact-directory: 'signed/Servy.CLI'

      - name: Inject signed Servy.CLI.exe
        shell: pwsh
        run: |
          $file = "signed/Servy.CLI/Servy.CLI.exe"
          if (-not (Test-Path $file)) { throw "Signed Servy.CLI.exe not found!" }
          Copy-Item $file src/Servy.CLI/bin/$env:CONFIGURATION/$env:TFM/$env:RUNTIME/publish/Servy.CLI.exe -Force

      # -----------------------------------------------------
      # Build UNSIGNED installer
      # -----------------------------------------------------
      - name: Build unsigned installer
        shell: pwsh
        run: |
          & "$env:ISCC" "setup\servy.iss" /DMyAppVersion=$env:VERSION

      # -----------------------------------------------------
      # SIGN installer
      # -----------------------------------------------------
      - name: Rename unsigned installer
        shell: pwsh
        run: |
          $source = "setup/servy-$env:VERSION-x64-installer.exe"
          $target = "servy-x64-installer.exe"
          if (-not (Test-Path $source)) { throw "Unsigned installer not found: $source" }
          Rename-Item -Path $source -NewName $target -Force

      - name: Upload installer (unsigned)
        id: unsigned-installer
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-installer
          path: setup/servy-x64-installer.exe
          if-no-files-found: error
          retention-days: 1

      - name: Submit installer for signing
        uses: signpath/github-action-submit-signing-request@v2
        with:
          organization-id: ${{ secrets.SIGNPATH_ORG_ID }}
          project-slug: ${{ vars.SIGNPATH_PROJECT_SLUG }}
          signing-policy-slug: ${{ vars.SIGNPATH_POLICY_SLUG }}
          api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
          github-artifact-id: '${{ steps.unsigned-installer.outputs.artifact-id }}'
          artifact-configuration-slug: 'servy-installer'
          wait-for-completion: true
          output-artifact-directory: 'signed/installer'

      - name: Rename signed installer
        shell: pwsh
        run: |
          $source = "signed/installer/servy-x64-installer.exe"
          $target = "servy-$env:VERSION-x64-installer.exe"
          if (-not (Test-Path $source)) { throw "Signed installer not found: $source" }
          Rename-Item -Path $source -NewName $target -Force

      - name: Upload signed installer
        uses: actions/upload-artifact@v4
        with:
          name: signed-installer
          path: signed/installer/servy-${{ env.VERSION }}-x64-installer.exe
          if-no-files-found: error
          retention-days: 1

      # -----------------------------------------------------
      # Build portable 7z package
      # -----------------------------------------------------
      - name: Build portable 7z package
        shell: pwsh
        run: |
          $name = "servy-$env:VERSION-x64-portable"
          $pkg = "$name"
          New-Item -ItemType Directory -Force -Path $pkg | Out-Null

          $servy = "src/Servy/bin/$env:CONFIGURATION/$env:TFM/$env:RUNTIME/publish/"
          $cli = "src/Servy.CLI/bin/$env:CONFIGURATION/$env:TFM/$env:RUNTIME/publish/"
          $manager = "src/Servy.Manager/bin/$env:CONFIGURATION/$env:TFM/$env:RUNTIME/publish/"

          # Desktop app and Manager app
          Copy-Item "$servy\Servy.exe" $pkg -Force
          Copy-Item "$manager\Servy.Manager.exe" $pkg -Force

          # CLI
          Copy-Item "$cli\Servy.CLI.exe" "$pkg\servy-cli.exe" -Force

          # PowerShell module
          Copy-Item "src/Servy.CLI/Servy.psm1" $pkg -Force
          Copy-Item "src/Servy.CLI/servy-module-examples.ps1" $pkg -Force
          
          # Task Scheduler setup
          Copy-Item "setup\taskschd" $pkg -Recurse -Force

          $zip = "$name.7z"

          # use advanced compression config
          & "$env:SEVEN_ZIP" a `
            -t7z `
            -m0=lzma2 `
            -mx=9 `
            -mfb=273 `
            -md=128m `
            -ms=on `
            "$zip" `
            "$pkg"

          Remove-Item $pkg -Recurse -Force

      - name: Upload portable package
        uses: actions/upload-artifact@v4
        with:
          name: portable-7z
          path: servy-${{ env.VERSION }}-x64-portable.7z
          if-no-files-found: error
          retention-days: 1

      # -----------------------------------------------------
      # Scan with VirusTotal
      # -----------------------------------------------------
      - name: Scan signed installer and portable package with VirusTotal
        uses: cssnr/virustotal-action@v1
        with:
          vt_api_key: ${{ secrets.VIRUSTOTAL_API_KEY }}
          sha256: true
          file_globs: |
            signed/installer/servy-${{ env.VERSION }}-x64-installer.exe
            servy-${{ env.VERSION }}-x64-portable.7z
