# ==============================================================================
# SBOM Generation Workflow
# ==============================================================================
#
# Purpose:
#   This workflow generates a CycloneDX Software Bill of Materials (SBOM)
#   for the Servy solution and uploads it as a short-lived build artifact.
#
# Trigger:
#   Manually triggered via workflow_dispatch.
#
# Inputs:
#   version:
#     Required. Must be in Major.Minor format (e.g. 4.2).
#     The value is validated at runtime and used consistently for:
#       - SBOM metadata version
#       - Output filename
#       - Artifact name
#
# Security / Trust Notes:
#   - Version input is validated early and the workflow fails fast on error.
#   - Repository checkout uses full history to support provenance generation.
#   - The SBOM artifact is retained for 1 day to reduce exposure surface.
#
# Output:
#   - servy-<version>-net48-sbom.xml (CycloneDX XML)
#
# ==============================================================================

name: sbom

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version in Major.Minor format (e.g. 4.2)'
        required: true

jobs:
  sbom:
    runs-on: windows-latest

    steps:
      # -----------------------------------------------------
      # Validate version input (Major.Minor)
      # -----------------------------------------------------
      - name: Validate version format
        shell: pwsh
        run: |
          $version = '${{ github.event.inputs.version }}'

          if ($version -notmatch '^\d+\.\d+$') {
            Write-Error "Invalid version format '$version'. Expected Major.Minor (e.g. 4.2)."
            exit 1
          }

          Write-Host "Version format validated: $version"
          
      # -----------------------------------------------------
      # Checkout repository
      # -----------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Required for provenance

      # -----------------------------------------------------
      # Build and Publish SBOM
      # -----------------------------------------------------
      - name: Install the latest .NET SDK
        shell: powershell
        run: |
          $url = "https://dot.net/v1/dotnet-install.ps1"
          Invoke-WebRequest -Uri $url -OutFile "dotnet-install.ps1" -ErrorAction Stop
          ./dotnet-install.ps1 -Version "latest" -InstallDir "$env:RUNNER_TEMP\dotnet"
          Add-Content -Path $env:GITHUB_PATH -Value "$env:RUNNER_TEMP\dotnet"

      - name: Check .NET version
        run: dotnet --version

      - name: Install CycloneDX .NET Tool
        shell: pwsh
        run: |
          dotnet tool install --global CycloneDX
          Add-Content -Path $env:GITHUB_PATH -Value "$env:USERPROFILE\.dotnet\tools"

      - name: Install CycloneDX CLI
        shell: pwsh
        run: |
          choco install cyclonedx-cli -y

      - name: Generate SBOM
        shell: pwsh
        run: |
          dotnet-CycloneDX "src\Servy\Servy.csproj" --set-version "${{ github.event.inputs.version }}.0" --output . --filename "servy-Servy.xml"
          dotnet-CycloneDX "src\Servy.Manager\Servy.Manager.csproj" --set-version "${{ github.event.inputs.version }}.0" --output . --filename "servy-Servy.Manager.xml"
          dotnet-CycloneDX "src\Servy.CLI\Servy.CLI.csproj" --set-version "${{ github.event.inputs.version }}.0" --output . --filename "servy-Servy.CLI.xml"
          dotnet-CycloneDX "src\Servy.CLI\Servy.Service.csproj" --set-version "${{ github.event.inputs.version }}.0" --output . --filename "servy-Servy.Service.xml"
          dotnet-CycloneDX "src\Servy.CLI\Servy.Restarter.csproj" --set-version "${{ github.event.inputs.version }}.0" --output . --filename "servy-Servy.Restarter.xml"
          
          # Merge into servy-${{ github.event.inputs.version }}-net48-sbom.xml
          cyclonedx merge `
            servy-Servy.xml `
            servy-Servy.Manager.xml `
            servy-Servy.CLI.xml `
            servy-Servy.Service.xml `
            servy-Servy.Restarter.xml `
            --output "servy-${{ github.event.inputs.version }}-net48-sbom.xml"

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ github.event.inputs.version }}-net48-sbom
          path: servy-${{ github.event.inputs.version }}-net48-sbom.xml
          if-no-files-found: error
          retention-days: 1
